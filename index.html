<!DOCTYPE html>
<html>
<head>
    <title>Cave Game | Interactive Map</title>
    <style>
        #map { height: 800px; width: 800px; margin: auto; position: relative; }
        #controls { text-align: center; margin-top: 20px; }
        #info-box {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            z-index: 1000;
        }
        #sheep-selector-box {
            position: absolute;
            top: 100px;
            right: 10px;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            z-index: 1000;
        }
        #cave-selector-box {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            z-index: 1000;
        }
        svg {
            display: block;
        }
    </style>
</head>
<body>
<div id="map">
    <div id="info-box">
        <p id="cell-info">Click on a cell to get infos</p>
    </div>
    <div id="sheep-selector-box">
        <select id="sheep-selector">
            <option value="">Select a sheep</option>
        </select>
    </div>
    <div id="cave-selector-box">
        <p id="current-cave">Current Cave: 35</p>
        <input type="number" id="cave-number" placeholder="Enter cave number" />
        <button id="cave-btn">Load Cave</button>
    </div>
</div>
<div id="controls">
    <input type="number" id="x-coord" placeholder="X" />
    <input type="number" id="y-coord" placeholder="Y" />
    <button id="center-btn">Center</button>
</div>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script>
    const width = 800;
    const height = 800;
    const gridSize = 400;
    const cellSize = 2;

    const COLORS = {
        REVEALED: "#ccc",
        ACTUAL: "red",
        DIGGABLE: "green"
    };

    const svg = d3.select("#map").append("svg")
        .attr("width", width)
        .attr("height", height);

    const container = svg.append("g");

    const zoom = d3.zoom()
        .scaleExtent([0.5, 10])
        .on("zoom", (event) => {
            container.attr("transform", event.transform);
        });

    svg.call(zoom);

    const urlParams = new URLSearchParams(window.location.search);
    let COLLECTION_NAME = urlParams.get('cave') || '35';
    const BACKEND_URL = 'cavegame.slkzgm.com';

    const sheepData = {};

    function drawGrid() {
        for (let i = 0; i < gridSize; i++) {
            for (let j = 0; j < gridSize; j++) {
                container.append("rect")
                    .attr("x", i * cellSize)
                    .attr("y", j * cellSize)
                    .attr("width", cellSize)
                    .attr("height", cellSize)
                    .attr("stroke", "black")
                    .attr("stroke-width", 0.25)
                    .attr("fill", "#333")
                    .attr("diggable", "false")
                    .attr("revealed", "false")
                    .on("click", () => {
                        const rect = container.select(`rect[x="${i * cellSize}"][y="${j * cellSize}"]`);
                        const revealed = rect.attr("revealed");
                        const diggable = rect.attr("diggable");

                        document.getElementById('cell-info').innerHTML = `Position: (${i}, ${j})<br>Revealed: ${revealed}<br>Diggable: ${diggable}`;
                    });
            }
        }
    }

    function setActualCell(x, y, diggable) {
        const rect = container.select(`rect[x="${x * cellSize}"][y="${y * cellSize}"]`);

        rect
            .attr("fill", diggable ? COLORS.DIGGABLE : COLORS.ACTUAL)
            .attr("revealed", "true")
            .attr("diggable", diggable.toString());
    }

    function setHistoryCell(x, y) {
        const rect = container.select(`rect[x="${x * cellSize}"][y="${y * cellSize}"]`);
        const diggable = rect.attr("diggable");

        rect
            .attr("fill", diggable === "true" ? COLORS.DIGGABLE : COLORS.REVEALED)
            .attr("revealed", "true");
    }

    function processAndRenderData(data) {
        data.forEach(item => {
            const { sheepId, totalSteps, history, coordinates: { x, y }, diggable } = item;

            // Stocker les informations sur les moutons
            sheepData[sheepId] = { totalSteps, coordinates: { x, y } };

            // Colorer les cellules de l'historique
            history.forEach(position => {
                const x = Math.floor(position % gridSize);
                const y = Math.floor(position / gridSize);

                setHistoryCell(x, y);
            });

            // Colorer la position actuelle
            setActualCell(x, y, diggable);
        });

        updateSheepSelector();
    }

    function updateSheepSelector() {
        const sheepSelector = document.getElementById('sheep-selector');
        sheepSelector.innerHTML = '<option value="">Select a sheep</option>';

        Object.keys(sheepData).forEach(sheepId => {
            const { coordinates: { x, y } } = sheepData[sheepId];
            const option = document.createElement('option');
            option.value = sheepId;
            option.textContent = `Sheep ${sheepId} (x: ${x}, y: ${y})`;
            sheepSelector.appendChild(option);
        });
    }

    function centerOnSheep(sheepId) {
        const { coordinates: { x, y } } = sheepData[sheepId];
        const currentTransform = d3.zoomTransform(svg.node());
        const scale = currentTransform.k;
        const translateX = width / 2 - x * cellSize * scale;
        const translateY = height / 2 - y * cellSize * scale;
        const transform = d3.zoomIdentity.translate(translateX, translateY).scale(scale);
        svg.transition().duration(750).call(zoom.transform, transform);
    }

    function loadCaveData() {
        fetch(`https://${BACKEND_URL}/data?collectionName=${COLLECTION_NAME}`)
            .then(response => response.json())
            .then(data => {
                processAndRenderData(data);
                document.getElementById('current-cave').innerText = `Current Cave: ${COLLECTION_NAME}`;
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });

        // WebSocket pour récupérer les données en temps réel
        const socket = new WebSocket(`wss://${BACKEND_URL}`);

        socket.addEventListener('message', function (event) {
            const data = JSON.parse(event.data);
            console.log('Message from server ', data);
            processAndRenderData([data]);
        });
    }


    document.getElementById('cave-number').value = COLLECTION_NAME;
    drawGrid();
    loadCaveData();

    document.getElementById('center-btn').addEventListener('click', function() {
        const x = parseInt(document.getElementById('x-coord').value) * cellSize;
        const y = parseInt(document.getElementById('y-coord').value) * cellSize;
        const currentTransform = d3.zoomTransform(svg.node());
        const scale = currentTransform.k;
        const translateX = width / 2 - x * scale;
        const translateY = height / 2 - y * scale;
        const transform = d3.zoomIdentity.translate(translateX, translateY).scale(scale);
        svg.transition().duration(750).call(zoom.transform, transform);
    });

    document.getElementById('sheep-selector').addEventListener('change', function() {
        const sheepId = this.value;
        if (sheepId) {
            centerOnSheep(sheepId);
        }
    });

    document.getElementById('cave-btn').addEventListener('click', function() {
        container.selectAll("rect").remove();
        drawGrid();
        loadCaveData();
    });

</script>
</body>
</html>